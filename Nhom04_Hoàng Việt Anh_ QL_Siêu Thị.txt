-- Cơ sở dữ liệu quản lý Siêu Thị
-- Tên thành viên:
-- Hoàng Việt Anh
-- Nguyễn Đức Hoàng

-- Gồm:
-- 23 Bảng
-- 3 view
-- 9 procedure
-- 9 function
-- 13 trigger





CREATE DATABASE SIEUTHITEST1
GO

drop DATABASE SIEUTHITEST1

USE SIEUTHITEST1
GO

------------------ CREATE TABLE ----------------------
CREATE TABLE TINH_THANHPHO
(
    MATP CHAR(5) NOT NULL,
    TENTP NVARCHAR(50),
    PRIMARY KEY (MATP)
)
GO

CREATE TABLE QUAN_HUYEN
(
    MAQ CHAR(5) NOT NULL,
    TENQ NVARCHAR(50),
    PRIMARY KEY (MAQ)
)
GO


CREATE TABLE NHACUNGCAP
(
    MANCC CHAR(5) NOT NULL,
    TENNCC NVARCHAR(100) NOT NULL,
    PRIMARY KEY (MANCC)
)
GO

CREATE TABLE DIACHI_NCC
(
    MANCC CHAR(5) NOT NULL,
    MATP CHAR(5) NOT NULL,
    MAQ CHAR(5) NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    PRIMARY KEY (MANCC),
    FOREIGN KEY (MATP) REFERENCES TINH_THANHPHO(MATP),
    FOREIGN KEY (MAQ) REFERENCES QUAN_HUYEN(MAQ),
    FOREIGN KEY (MANCC) REFERENCES NHACUNGCAP(MANCC)
)
GO

CREATE TABLE SDT_NHACUNGCAP
(
    MANCC CHAR(5) NOT NULL,
    MADT CHAR(5) NOT NULL,
    SODT NVARCHAR(50),
    PRIMARY KEY (MADT),
    FOREIGN KEY (MANCC) REFERENCES NHACUNGCAP(MANCC)
)
GO

CREATE TABLE EMAIL_NCC
(
    MANCC CHAR(5) NOT NULL,
    MAE CHAR(5) NOT NULL,
    EMAIL NVARCHAR(50),
    PRIMARY KEY (MAE),
    FOREIGN KEY (MANCC) REFERENCES NHACUNGCAP(MANCC)
)
GO

CREATE TABLE CHINHANH
(
    MACN CHAR(5) NOT NULL,
    TENCN NVARCHAR(100),
    -- HESOGIA FLOAT,
    PRIMARY KEY (MACN)
)
GO

CREATE TABLE SDT_CHINHANH
(
    MACN CHAR(5) NOT NULL,
    MADT CHAR(5) NOT NULL,
    SODT NVARCHAR(50),
    PRIMARY KEY (MADT),
    FOREIGN KEY (MACN) REFERENCES CHINHANH(MACN)
)
GO

CREATE TABLE DIACHI_CHINHANH
(
    MACN CHAR(5) NOT NULL,
    MATP CHAR(5) NOT NULL,
    MAQ CHAR(5) NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    PRIMARY KEY (MACN),
    FOREIGN KEY (MATP) REFERENCES TINH_THANHPHO(MATP),
    FOREIGN KEY (MAQ) REFERENCES QUAN_HUYEN(MAQ),
    FOREIGN KEY (MACN) REFERENCES CHINHANH(MACN)
)
GO

CREATE TABLE CHUCVU
(
    MACV CHAR(3) NOT NULL,
    TENCV NVARCHAR(50),
    PRIMARY KEY (MACV)
)
GO

CREATE TABLE NHANVIEN
(
    MANV CHAR(5) NOT NULL,
    TENNV NVARCHAR(100),
    MACV CHAR(3) NOT NULL,
    MACN CHAR(5) NOT NULL,
    NGAYSINH DATETIME,
    GIOITINH BIT,
    NGAYVAO DATETIME,
    NGAYNGHI DATETIME,
    PRIMARY KEY (MANV),
    FOREIGN KEY (MACV) REFERENCES CHUCVU(MACV),
    FOREIGN KEY (MACN) REFERENCES CHINHANH(MACN)
)
GO

CREATE TABLE DIACHI_NHANVIEN
(
    MANV CHAR(5) NOT NULL,
    MATP CHAR(5) NOT NULL,
    MAQ CHAR(5) NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    PRIMARY KEY (MANV),
    FOREIGN KEY (MATP) REFERENCES TINH_THANHPHO(MATP),
    FOREIGN KEY (MAQ) REFERENCES QUAN_HUYEN(MAQ),
    FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
GO

CREATE TABLE SDT_NHANVIEN
(
    MANV CHAR(5) NOT NULL,
    MADT CHAR(5) NOT NULL,
    SODT NVARCHAR(50),
    PRIMARY KEY (MADT),
    FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
GO

CREATE TABLE EMAIL_NHANVIEN
(
    MANV CHAR(5) NOT NULL,
    MAE CHAR(5) NOT NULL,
    EMAIL NVARCHAR(50),
    PRIMARY KEY (MAE),
    FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
GO

CREATE TABLE PHIEUCHI
(
    MAPC CHAR(10) NOT NULL,
    MANV CHAR(5) NOT NULL,
    NOIDUNGCHI NVARCHAR(MAX),
    NGAYLAP DATETIME,
    TONGTIEN DECIMAL,
    PRIMARY KEY (MAPC),
    FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
GO

CREATE TABLE PHIEUPHUTHU
(
    MAPHIEUPT CHAR(10) NOT NULL,
    MANV CHAR(5) NOT NULL,
    TENPPT NVARCHAR(100),
    NGAYLAP DATETIME,
    SOTIEN DECIMAL,
    PRIMARY KEY (MAPHIEUPT),
    CONSTRAINT FK_PHIEUPHUTHU_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
)
GO

CREATE TABLE PHIEUNHAP
(
    MAPN CHAR(10) NOT NULL,
    MANV CHAR(5) NOT NULL,
    MANCC CHAR(5) NOT NULL,
    NGAYLAP DATETIME,
    TONGTIEN DECIMAL,
    PRIMARY KEY (MAPN),
    CONSTRAINT FK_PHIEUNHAP_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
    CONSTRAINT FK_PHIEUNHAP_MANCC FOREIGN KEY (MANCC) REFERENCES
    NHACUNGCAP(MANCC)
)
GO

CREATE TABLE BAOCAO
(
    MABC CHAR(10) NOT NULL,
    MANV CHAR(5) NOT NULL,
    TENBC NVARCHAR(100),
    NGAYLAP DATETIME,
    NOIDUNG NVARCHAR(MAX),
    PRIMARY KEY (MABC),
    CONSTRAINT FK_BAOCAO_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)
GO

CREATE TABLE HOADON 
(
    MAHD CHAR(50) NOT NULL,
    MANV CHAR(5) NOT NULL,
    NGAYLAP DATETIME,
    TONGTIEN DECIMAL,
    PRIMARY KEY (MAHD),
    CONSTRAINT FK_HOADON_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

)
GO


CREATE TABLE LOAISANPHAM
(
    MALOAI CHAR(5) NOT NULL,
    TENLOAI NVARCHAR(100),
    PRIMARY KEY( MALOAI)
)

CREATE TABLE SANPHAM
(
    MASP CHAR(5) NOT NULL,
    MALOAI CHAR(5) NOT NULL,
    TENSANPHAM NVARCHAR(100),
    -- SOLUONG FLOAT,
    DONGIA DECIMAL,
    PRIMARY KEY (MASP),
    FOREIGN KEY (MALOAI) REFERENCES LOAISANPHAM(MALOAI)
)


CREATE TABLE CHITIET_HOADON
(
    MASP CHAR(5) NOT NULL,
    MAHD CHAR(50) NOT NULL,
    SOLUONG FLOAT,
    PRIMARY KEY(MASP,MAHD),
    CONSTRAINT FK_CHITIET_HOADON_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP),
    CONSTRAINT FK_CHITIET_HOADON_MAHD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
)
GO

CREATE TABLE CHITIET_PHIEUNHAP
(
    MASP CHAR(5) NOT NULL,
    MAPN CHAR(10) NOT NULL,
    SOLUONG FLOAT,
    PRIMARY KEY (MASP, MAPN),
    CONSTRAINT FK_CHITIET_PHIEUNHAP_MASANPHAM FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP),
    CONSTRAINT FK_CHITIET_PHIEUNHAP_MAPN FOREIGN KEY (MAPN) REFERENCES PHIEUNHAP(MAPN)
)
GO



---------------------------------INSERT------------------------------------


INSERT INTO [dbo].[TINH_THANHPHO]
( -- Columns to insert data into
 [MATP], [TENTP]
)
VALUES
(1, N' LAO CAI'),
(2, N'HA NOI'),
(3, N'HAI PHONG'),
(4, N'YEN BAI'),
(5, N'DA NANG'),
(6, N'HO CHI MINH'),
(7, N'CAN THO'),
(8, N'HOA BINH'),
(9, N'SON LA'),
(10, N'DIEN BIEN'),
(11, N'PHU THO'),
(12, N'HA GIANG'),
(13, N'CAO BANG'),
(14, N'THAI NGUYEN'),
(15, N'HA NAM'),
(16, N'NAM DINH'),
(17, N'NINH BINH'),
(18, N'THAI BINH'),
(19, N'KHANH HOA'),
(20, N'DONG THAP')
GO


INSERT INTO [dbo].[QUAN_HUYEN]
([MAQ], [TENQ])
VALUES
(1, N' DONG ANH'),
(2, N' HOANG MAI'),
(3, N'DAN PHUONG'),
(4, N'GIA LAM'),
(5, N'HOAI DUC'),
(6, N'BA VI'),
(7, N'MY DUC'),
(8, N'PHUC THO'),
(9, N'ME LINH'),
(10, N'SOC SON'),
(11, N'THACH THAT'),
(12, N'QUOC OAI'),
(13, N'THANH TRI'),
(14, N'THANH OAI'),
(15, N'PHU XUYEN'),
(16, N'THANH XUAN'),
(17, N'BA DINH'),
(18, N'CAU GIAY'),
(19, N'HOAN KIEM'),
(20, N'HAI BA TRUNG')
GO


INSERT INTO [dbo].[NHACUNGCAP]
([MANCC], [TENNCC])
VALUES
(1, N'AJINOMOTO'),
(2, N'TOYOTA'),
(3, N'KINHDO'),
(4, N'ORION'),
(5, N'TRANG AN'),
(6, N'OISHI'),
(7, N'MEIJI'),
(8, N'NESTLE'),
(9, N'BIBICA'),
(10, N'HAI HA'),
(11, N'HUU NGHI'),
(12, N'LOTTE'),
(13, N'VIETFOOD'),
(14, N'LUBICO'),
(15, N'HAI CHAU'),
(16, N'ABC BAKERY'),
(17, N'VINAMILK'),
(18, N'RICHY'),
(19, N'BAKERY'),
(20, N'PEPPIE')
GO


INSERT INTO [dbo].[DIACHI_NCC]
([MANCC], [MAQ], [MATP], [DIACHI])
VALUES
(1, 1, 1, N'DONG ANH'),
(2, 2, 2, N'HOANG MAI'),
(3, 3, 3, N'DAN PHUONG'),
(4, 4, 4, N'GIA LAM'),
(5, 5, 5, N'HOAI DUC'),
(6, 6, 6, N'BA VI'),
(7, 7, 7, N'MY DUC'),
(8, 8, 8, N'PHUC THO'),
(9, 9, 9, N'ME LINH'),
(10, 10, 10, N'SOC SON'),
(11, 11, 11, N'THACH THAT'),
(12, 12, 12, N'QUOC OAI'),
(13, 13, 13, N'THANH TRI'),
(14, 14, 14, N'THANH OAI'),
(15, 15, 15, N'PHU XUYEN'),
(16, 16, 16, N'THANH XUAN'),
(17, 17, 17, N'BA DINH'),
(18, 18, 18, N'CAU GIAY'),
(19, 19, 19, N'HOAN KIEM'),
(20, 20, 20, N'HAI BA TRUNG')
GO


INSERT INTO [dbo].[SDT_NHACUNGCAP]
([MANCC], [MADT], [SODT])
VALUES
(1, 1, N'0123456789'),
(2, 2, N'0453456789'),
(3, 3, N'0563456789'),
(4, 4, N'0355456789'),
(5, 5, N'0253456789'),
(6, 6, N'0823456789'),
(7, 7, N'0983456789'),
(8, 8, N'0927456789'),
(9, 9, N'0823456559'),
(10, 10, N'0923456755'),
(11, 11, N'0873456785'),
(12, 12, N'0543456799'),
(13, 13, N'0993456789'),
(14, 14, N'0893456756'),
(15, 15, N'0563456789'),
(16, 16, N'0893456876'),
(17, 17, N'0983456785'),
(18, 18, N'0583456723'),
(19, 19, N'0943456733'),
(20, 20, N'0783456766')
GO



INSERT INTO [dbo].[EMAIL_NCC]
([MANCC], [MAE], [EMAIL])
VALUES
(1, 1, N'A@GMAIL.COM'),
(2, 2, N'B@GMAIL.COM'),
(3, 3, N'V@GMAIL.COM'),
(4, 4, N'C@GMAIL.COM'),
(5, 5, N'D@GMAIL.COM'),
(6, 6, N'F@GMAIL.COM'),
(7, 7, N'G@GMAIL.COM'),
(8, 8, N'H@GMAIL.COM'),
(9, 9, N'J@GMAIL.COM'),
(10, 10, N'P@GMAIL.COM'),
(11, 11, N'O@GMAIL.COM'),
(12, 12, N'I@GMAIL.COM'),
(13, 13, N'U@GMAIL.COM'),
(14, 14, N'Y@GMAIL.COM'),
(15, 15, N'T@GMAIL.COM'),
(16, 16, N'R@GMAIL.COM'),
(17, 17, N'E@GMAIL.COM'),
(18, 18, N'W@GMAIL.COM'),
(19, 19, N'Q@GMAIL.COM'),
(20, 20, N'X@GMAIL.COM')
GO


INSERT INTO [dbo].[CHINHANH]
( 
 [MACN], [TENCN]
)
VALUES
(1, N'HA NOI'),
(2, N'HO CHI MINH'),
(3, N'SAI GON'),
(4, N'DA LAT'),
(5, N'HAI PHONG'),
(6, N'BAC CAN'),
(7, N'THANH HOA'),
(8, N'CAO BANG'),
(9, N'CA MAU'),
(10, N'NINH BINH'),
(11, N'AN GIANG'),
(12, N'THAI BINH'),
(13, N'NAM DINH'),
(14, N'THAI NGUYEN'),
(15, N'QUANG NINH'),
(16, N'BAC GIANG'),
(17, N'DIEN BIEN'),
(18, N'YEN BAI'),
(19, N'HOA BINH'),
(20, N'SƠN LA')
GO


INSERT INTO [dbo].[SDT_CHINHANH]
( -- Columns to insert data into
 [MACN], [MADT], [SODT]
)
VALUES
(1, 1, N'0123456789'),
(2, 2, N'0453456789'),
(3, 3, N'0673456789'),
(4, 4, N'0863456789'),
(5, 5, N'0523456789'),
(6, 6, N'0823456789'),
(7, 7, N'0523456789'),
(8, 8, N'0783456789'),
(9, 9, N'0903456789'),
(10, 10, N'0343456789'),
(11, 11, N'0973456789'),
(12, 12, N'0563456789'),
(13, 13, N'0873456789'),
(14, 14, N'0893456789'),
(15, 15, N'0876456789'),
(16, 16, N'0953456789'),
(17, 17, N'0983456789'),
(18, 18, N'0553456789'),
(19, 19, N'0663456789'),
(20, 20, N'0773456789')
GO



INSERT INTO [dbo].[DIACHI_CHINHANH]
([MACN], [MATP], [MAQ], [DIACHI])
VALUES
(1, 1, 1, N'DONG ANH'),
(2, 2, 2, N'HOANG MAI'),
(3, 3, 3, N'DAN PHUONG'),
(4, 4, 4, N'GIA LAM'),
(5, 5, 5, N'HOAI DUC'),
(6, 6, 6, N'BA VI'),
(7, 7, 7, N'MY DUC'),
(8, 8, 8, N'PHUC THO'),
(9, 9, 9, N'ME LINH'),
(10, 10, 10, N'SOC SON'),
(11, 11, 11, N'THACH THAT'),
(12, 12, 12, N'QUOC OAI'),
(13, 13, 13, N'THANH TRI'),
(14, 14, 14, N'THANH OAI'),
(15, 15, 15, N'PHU XUYEN'),
(16, 16, 16, N'THANH XUAN'),
(17, 17, 17, N'BA DINH'),
(18, 18, 18, N'CAU GIAY'),
(19, 19, 19, N'HOAN KIEM'),
(20, 20, 20, N'HAI BA TRUNG')
GO



INSERT INTO [dbo].[CHUCVU]
([MACV], [TENCV])
VALUES
(1, N'TRUONG PHONG'),
(2, N'THU KI'),
(3, N'NHAN VIEN'),
(4, N'BAO VE'),
(5, N'NHAN VIEN'),
(6, N'NHAN VIEN'),
(7, N'BAO VE'),
(8, N'BAO VE'),
(9, N'TRUONG PHONG'),
(10, N'NHAN VIEN'),
(11, N'BAO VE'),
(12, N'BAO VE'),
(13, N'NHAN VIEN'),
(14, N'NHAN VIEN'),
(15, N'NHAN VIEN'),
(16, N'BAO VE'),
(17, N'BAO VE'),
(18, N'TRUONG PHONG'),
(19, N'THU KI'),
(20, N'THU KI')
GO



INSERT INTO [dbo].[NHANVIEN]
(
 [MANV], [TENNV], [MACV],[MACN],[NGAYSINH],[GIOITINH],[NGAYVAO],[NGAYNGHI]
)
VALUES
(1, 1, 1, 1,'20031024','1','20030101',NULL),
(2, 2, 2, 2,'20021201','0','20030101',NULL),
(3, 3, 3, 3,'20000524','0','20040102',NULL),
(4, 4, 4, 4,'20011227','1','20130201',NULL),
(5, 5, 5, 5,'20041228','0','20070110',NULL),
(6, 6, 6, 6,'20001224','0','20050601',NULL),
(7, 7, 7, 7,'20001225','1','20031001',NULL),
(8, 8, 8, 8,'20001214','1','20090107',NULL),
(9, 9, 9, 9,'20001124','1','20040201',NULL),
(10, 10, 10, 10,'20021024','1','20090112',NULL),
(11, 11, 11, 11,'20041024','1','20060901',NULL),
(12, 12, 12, 12,'20031224','0','20030701',NULL),
(13, 13, 13, 13,'20030224','1','20080901',NULL),
(14, 14, 14, 14,'20010924','1','20030501',NULL),
(15, 15, 15, 15,'20010324','1','20030901',NULL),
(16, 16, 16, 16,'20001224','0','20080108',NULL),
(17, 17, 17, 17,'20000924','1','20050401',NULL),
(18, 18, 18, 18,'20020611','0','20030607',NULL),
(19, 19, 19, 19,'20021222','1','20090809',NULL),
(20, 20, 20, 20,'20031229','1','20090211',NULL)
GO


INSERT INTO [dbo].[DIACHI_NHANVIEN]
([MANV], [MATP], [MAQ],[DIACHI])
VALUES
(1, 1, 1, N'DONG ANH'),
(2, 2, 2, N'HOANG MAI'),
(3, 3, 3, N'DAN PHUONG'),
(4, 4, 4, N'GIA LAM'),
(5, 5, 5, N'HOAI DUC'),
(6, 6, 6, N'BA VI'),
(7, 7, 7, N'MY DUC'),
(8, 8, 8, N'PHUC THO'),
(9, 9, 9, N'ME LINH'),
(10, 10, 10, N'SOC SON'),
(11, 11, 11, N'THACH THAT'),
(12, 12, 12, N'QUOC OAI'),
(13, 13, 13, N'THANH TRI'),
(14, 14, 14, N'THANH OAI'),
(15, 15, 15, N'PHU XUYEN'),
(16, 16, 16, N'THANH XUAN'),
(17, 17, 17, N'BA DINH'),
(18, 18, 18, N'CAU GIAY'),
(19, 19, 19, N'HOAN KIEM'),
(20, 20, 20, N'HAI BA TRUNG')

GO


INSERT INTO [dbo].[SDT_NHANVIEN]
([MANV], [MADT], [SODT])
VALUES
(1, 1, N'0123456789'),
(2, 2, N'0453456789'),
(3, 3, N'0563456789'),
(4, 4, N'0355456789'),
(5, 5, N'0253456789'),
(6, 6, N'0823456789'),
(7, 7, N'0983456789'),
(8, 8, N'0927456789'),
(9, 9, N'0823456559'),
(10, 10, N'0923456755'),
(11, 11, N'0873456785'),
(12, 12, N'0543456799'),
(13, 13, N'0993456789'),
(14, 14, N'0893456756'),
(15, 15, N'0563456789'),
(16, 16, N'0893456876'),
(17, 17, N'0983456785'),
(18, 18, N'0583456723'),
(19, 19, N'0943456733'),
(20, 20, N'0783456766')
GO


INSERT INTO [dbo].[EMAIL_NHANVIEN]
([MANV], [MAE], [EMAIL])
VALUES
(1, 1, N'A@GMAIL.COM'),
(2, 2, N'B@GMAIL.COM'),
(3, 3, N'V@GMAIL.COM'),
(4, 4, N'C@GMAIL.COM'),
(5, 5, N'D@GMAIL.COM'),
(6, 6, N'F@GMAIL.COM'),
(7, 7, N'G@GMAIL.COM'),
(8, 8, N'H@GMAIL.COM'),
(9, 9, N'J@GMAIL.COM'),
(10, 10, N'P@GMAIL.COM'),
(11, 11, N'O@GMAIL.COM'),
(12, 12, N'I@GMAIL.COM'),
(13, 13, N'U@GMAIL.COM'),
(14, 14, N'Y@GMAIL.COM'),
(15, 15, N'T@GMAIL.COM'),
(16, 16, N'R@GMAIL.COM'),
(17, 17, N'E@GMAIL.COM'),
(18, 18, N'W@GMAIL.COM'),
(19, 19, N'Q@GMAIL.COM'),
(20, 20, N'X@GMAIL.COM')
GO


INSERT INTO [dbo].[PHIEUCHI]
([MAPC], [MANV], [NOIDUNGCHI],[NGAYLAP],[TONGTIEN])
VALUES
(1, 1, N'TIEN DIEN', '20230105', 15000600),
(2, 2, N'TIEN NUOC', '20230205', 17008000),
(3, 3, N'TIEN DIEN', '20230406', 10003000),
(4, 4, N'TIEN NUOC', '20230315', 11020000),
(5, 5, N'TIEN DIEN', '20230509', 10012000),
(6, 6, N'TIEN NUOC', '20230609', 12000400),
(7, 7, N'TIEN DIEN', '20230515', 15000700),
(8, 8, N'TIEN NUOC', '20230505', 18000000),
(9, 9, N'TIEN DIEN', '20230512', 19000000),
(10, 10, N'TIEN NUOC', '20230210', 10023000),
(11, 11, N'TIEN DIEN', '20230305', 10500000),
(12, 12, N'TIEN NUOC', '20230509', 10600000),
(13, 13, N'TIEN DIEN', '20230607', 100890000),
(14, 14, N'TIEN NUOC', '20230807', 10700000),
(15, 15, N'TIEN DIEN', '20230518', 12000000),
(16, 16, N'TIEN NUOC', '20230420', 10030000),
(17, 17, N'TIEN DIEN', '20230305', 10060000),
(18, 18, N'TIEN NUOC', '20230206', 10700000),
(19, 19, N'TIEN DIEN', '20231104', 10000800),
(20, 20, N'TIEN NUOC', '20230908', 10008700)
GO


INSERT INTO [dbo].[PHIEUPHUTHU]
([MAPHIEUPT], [MANV], [TENPPT],[NGAYLAP],[SOTIEN])
VALUES
(1, 1, N'TUI NILON','20230809',1000),
(2, 2, N'TUI NILON','20230905',1000),
(3, 3, N'TUI NILON','20230304',1000),
(4, 4, N'TUI NILON','20230204',1000),
(5, 5, N'TUI NILON','20230109',1000),
(6, 6, N'TUI NILON','20230106',1000),
(7, 7, N'TUI NILON','20230205',1000),
(8, 8, N'TUI NILON','20231009',1000),
(9, 9, N'TUI NILON','20231029',1000),
(10, 10, N'TUI NILON','20231101',1000),
(11, 11, N'TUI NILON','20231202',1000),
(12, 12, N'TUI NILON','20230105',1000),
(13, 13, N'TUI NILON','20230104',1000),
(14, 14, N'TUI NILON','20230107',1000),
(15, 15, N'TUI NILON','20231008',1000),
(16, 16, N'TUI NILON','20231205',1000),
(17, 17, N'TUI NILON','20230209',1000),
(18, 18, N'TUI NILON','20230223',1000),
(19, 19, N'TUI NILON','20230109',1000),
(20, 20, N'TUI NILON','20230101',1000)
GO


INSERT INTO [dbo].[PHIEUNHAP]
([MAPN], [MANV], [MANCC],[NGAYLAP],[TONGTIEN])
VALUES
(1, 1, 1, '20230101',15000000),
(2, 2, 2, '20231002',16000000),
(3, 3, 3, '20230201',14000000),
(4, 4, 4, '20231101',15060000),
(5, 5, 5, '20230201',16000700),
(6, 6, 6, '20231207',13000000),
(7, 7, 7, '20230211',10000400),
(8, 8, 8, '20231121',10400000),
(9, 9, 9, '20230112',17000000),
(10, 10, 10, '20230505',13000500),
(11, 11, 11, '20230606',10506000),
(12, 12, 12, '20230708',10300000),
(13, 13, 13, '20230709',18000000),
(14, 14, 14, '20230711',10009000),
(15, 15, 15, '20230912',10050000),
(16, 16, 16, '20230821',14000000),
(17, 17, 17, '20231029',18000000),
(18, 18, 18, '20231111',19006000),
(19, 19, 19, '20230123',14005000),
(20, 20, 20, '20231221',15000400)
GO




INSERT INTO [dbo].[BAOCAO]
([MABC], [MANV], [TENBC],[NGAYLAP],[NOIDUNG])
VALUES
(1, 1, N'BAO CAO 1','20230111',N'NHAP SAN PHAM'),
(2, 2, N'BAO CAO 2','20230211',N'NHAP SAN PHAM'),
(3, 3, N'BAO CAO 3','20230311',N'NHAP SAN PHAM'),
(4, 4, N'BAO CAO 4','20230412',N'NHAP SAN PHAM'),
(5, 5, N'BAO CAO 5','20230512',N'NHAP SAN PHAM'),
(6, 6, N'BAO CAO 6','20230612',N'NHAP SAN PHAM'),
(7, 7, N'BAO CAO 7','20230713',N'NHAP SAN PHAM'),
(8, 8, N'BAO CAO 8','20230804',N'NHAP SAN PHAM'),
(9, 9, N'BAO CAO 9','20230907',N'NHAP SAN PHAM'),
(10, 10, N'BAO CAO 10','20231009',N'NHAP SAN PHAM'),
(11, 11, N'BAO CAO 11','20231109',N'NHAP SAN PHAM'),
(12, 12, N'BAO CAO 12','20231211',N'NHAP SAN PHAM'),
(13, 13, N'BAO CAO 13','20230130',N'NHAP SAN PHAM'),
(14, 14, N'BAO CAO 14','20230209',N'NHAP SAN PHAM'),
(15, 15, N'BAO CAO 15','20230305',N'NHAP SAN PHAM'),
(16, 16, N'BAO CAO 16','20230406',N'NHAP SAN PHAM'),
(17, 17, N'BAO CAO 17','20230508',N'NHAP SAN PHAM'),
(18, 18, N'BAO CAO 18','20230609',N'NHAP SAN PHAM'),
(19, 19, N'BAO CAO 19','20230705',N'NHAP SAN PHAM'),
(20, 20, N'BAO CAO 20','20230807',N'NHAP SAN PHAM')
GO


INSERT INTO [dbo].[HOADON]
([MAHD], [MANV], [NGAYLAP],[TONGTIEN])
VALUES
(1, 1, '20230102',150000),
(2, 2, '20230203',140000),
(3, 3, '20230204',200000),
(4, 4, '20230305',150400),
(5, 5, '20230306',1000000),
(6, 6, '20230407',190000),
(7, 7, '20230408',200000),
(8, 8, '20230509',250000),
(9, 9, '20230510',300000),
(10, 10, '20230611',450000),
(11, 11, '20230612',556000),
(12, 12, '20230713',700000),
(13, 13, '20230714',500000),
(14, 14, '20230815',533000),
(15, 15, '20230916',2000000),
(16, 16, '20230917',432000),
(17, 17, '20230918',530000),
(18, 18, '20231019',730000),
(19, 19, '20231120',406000),
(20, 20, '20231221',263000)
GO



INSERT INTO [dbo].[LOAISANPHAM]
([MALOAI], [TENLOAI])
VALUES
(1, N'DO KHO'),
(2, N'DONG HOP'),
(3, N'TIEU DUNG'),
(4, N'DIEN TU'),
(5, N'TIEU DUNG'),
(6, N'DO MAT'),
(7, N'TIEU DUNG'),
(8, N'DIEN TU'),
(9, N'THUC PHAM'),
(10, N'GIAI KHAT'),
(11, N'DONG LANH'),
(12, N'DO KHO'),
(13, N'DO MAT'),
(14, N'BANH KEO'),
(15, N'GIA VI'),
(16, N'DONG LANH'),
(17, N'DIEN TU'),
(18, N'DIEN TU'),
(19, N'DO KHO '),
(20, N'DONG LANH')

GO



INSERT INTO [dbo].[SANPHAM]
([MASP], [MALOAI], [TENSANPHAM],[DONGIA])
VALUES
(1, 1, N'SUA MILO', 70000),
(2, 2, N'NUOC MAM',  80000),
(3, 3, N'BIMBIM',  70000),
(4, 4, N'BƠ', 50000),
(5, 5, N'PHO MAI', 90000),
(6, 6, N'XÚC XÍCH', 70000),
(7, 7, N'KEM', 50000),
(8, 8, N'DAU AN', 90000),
(9, 9, N'SUA ONG THO',  23000),
(10, 10, N'SUA BOT', 70000),
(11, 11, N'COCA', 80000),
(12, 12, N'PEPSI', 70000),
(13, 13, N'7UP', 70000),
(14, 14, N'CACAO', 70000),
(15, 15, N'CA PHE', 90000),
(16, 16, N'BANH QUY', 70000),
(17, 17, N'SOCOLA', 90000),
(18, 18, N'KHAU TRANG', 80000),
(19, 19, N'KHAN GIAY', 700000),
(20, 20, N'NUOC HOA', 2000000)
GO



INSERT INTO [dbo].[CHITIET_HOADON]
([MASP], [MAHD], [SOLUONG])
VALUES
(1, 1, 5),
(2, 2, 10),
(3, 3, 5),
(4, 4, 6),
(5, 5, 7),
(6, 6, 9),
(7, 7, 6),
(8, 8, 4),
(9, 9, 3),
(10, 10, 2),
(11, 11, 3),
(12, 12, 5),
(13, 13, 6),
(14, 14, 7),
(15, 15, 9),
(16, 16, 9),
(17, 17, 5),
(18, 18, 8),
(19, 19, 6),
(20, 20, 5)
GO


INSERT INTO [dbo].[CHITIET_PHIEUNHAP]
([MASP], [MAPN], [SOLUONG])
VALUES
(1, 1, 5),
(2, 2, 4),
(3, 3, 7),
(4, 4, 7),
(5, 5, 4),
(6, 6, 3),
(7, 7, 3),
(8, 8, 2),
(9, 9, 2),
(10, 10, 7),
(11, 11, 8),
(12, 12, 9),
(13, 13, 9),
(14, 14, 8),
(15, 15, 7),
(16, 16, 6),
(17, 17, 9),
(18, 18, 7),
(19, 19, 4),
(20, 20, 5)
GO




----------------------------------VIEW---------------------------------------------------


CREATE VIEW ALL1
AS
SELECT NHANVIEN.TENNV, DIACHI_CHINHANH.DIACHI, QUAN_HUYEN.TENQ , TINH_THANHPHO.TENTP, SDT_CHINHANH.SODT,
SANPHAM.TENSANPHAM, SANPHAM.DONGIA, HOADON.TONGTIEN, HOADON.NGAYLAP  FROM NHANVIEN, HOADON, QUAN_HUYEN, TINH_THANHPHO, CHINHANH, SDT_CHINHANH, DIACHI_CHINHANH, CHITIET_HOADON, SANPHAM, CHITIET_PHIEUNHAP, PHIEUNHAP
WHERE NHANVIEN.MANV = HOADON.MANV AND HOADON.MAHD = CHITIET_HOADON.MAHD AND CHITIET_HOADON.MASP= SANPHAM.MASP AND SANPHAM.MASP = CHITIET_PHIEUNHAP.MASP AND CHITIET_PHIEUNHAP.MAPN = PHIEUNHAP.MAPN AND PHIEUNHAP.MANV = NHANVIEN.MANV AND NHANVIEN.MACN = CHINHANH.MACN AND CHINHANH.MACN = SDT_CHINHANH.MACN AND CHINHANH.MACN = DIACHI_CHINHANH.MACN AND DIACHI_CHINHANH.MATP = TINH_THANHPHO.MATP AND DIACHI_CHINHANH.MAQ= QUAN_HUYEN.MAQ
GO 


SELECT * FROM ALL1
GO




CREATE VIEW [THONGTINNV]
AS
SELECT NHANVIEN.MANV, TENNV, NGAYSINH, GIOITINH,NGAYVAO,NGAYNGHI,TENCV,EMAIL_NHANVIEN.EMAIL, SDT_NHANVIEN.SODT, DIACHI_NHANVIEN.DIACHI, QUAN_HUYEN.TENQ , TINH_THANHPHO.TENTP 
FROM NHANVIEN , CHUCVU ,SDT_NHANVIEN ,EMAIL_NHANVIEN,DIACHI_NHANVIEN,TINH_THANHPHO,QUAN_HUYEN
WHERE NHANVIEN.MANV= DIACHI_NHANVIEN.MANV AND NHANVIEN.MANV=EMAIL_NHANVIEN.MANV AND SDT_NHANVIEN.MANV= NHANVIEN.MANV AND NHANVIEN.MACV = CHUCVU.MACV AND DIACHI_NHANVIEN.MATP = TINH_THANHPHO.MATP AND DIACHI_NHANVIEN.MAQ=QUAN_HUYEN.MAQ
GO

SELECT * FROM [THONGTINNV]
GO




CREATE VIEW THONGTINNHACC
AS
SELECT NHACUNGCAP.MANCC, NHACUNGCAP.TENNCC, SDT_NHACUNGCAP.SODT, DIACHI_NCC.DIACHI,EMAIL_NCC.EMAIL, QUAN_HUYEN.TENQ, TINH_THANHPHO.TENTP FROM NHACUNGCAP, SDT_NHACUNGCAP, DIACHI_NCC,EMAIL_NCC, QUAN_HUYEN,TINH_THANHPHO
WHERE NHACUNGCAP.MANCC = DIACHI_NCC.MANCC AND NHACUNGCAP.MANCC = EMAIL_NCC.MANCC AND NHACUNGCAP.MANCC=SDT_NHACUNGCAP.MANCC AND DIACHI_NCC.MATP = TINH_THANHPHO.MATP AND DIACHI_NCC.MAQ = QUAN_HUYEN.MAQ
GO

SELECT * FROM THONGTINNHACC
GO





---------------------------------- PRODUCES ----------------------------------------


-----------------------------------1------------------------------
-- THỦ TỤC NHẬP NHÂN VIÊN PHẢI SAU NGÀY THÀNH LẬP > 1/1/2023
CREATE PROCEDURE THEM_NHANVIEN
@MANV CHAR(5),
@TENNV NVARCHAR(100),
@MACV CHAR(3),
@MACN CHAR(5),
@NGAYSINH DATETIME,
@GIOITINH BIT,
@NGAYVAO DATETIME,
@NGAYNGHI DATETIME
AS
BEGIN
IF EXISTS(SELECT * FROM CHUCVU WHERE CHUCVU.MACV = @MACV)
    BEGIN
        IF EXISTS(SELECT * FROM CHINHANH WHERE CHINHANH.MACN = @MACN)
            BEGIN
            IF(@NGAYVAO > '01/01/2023')
                INSERT INTO NHANVIEN VALUES( @MANV,@TENNV,@MACV,@MACN, @NGAYSINH,@GIOITINH,@NGAYVAO,@NGAYNGHI)
            ELSE
            PRINT N'LOI NGAY  VAO < NGAY THANH LAP'
            END
        ELSE
        PRINT N'LOI KHONG TON TAI MACN'
    END
ELSE
PRINT N'LOI KHONG TON TAI MACV'
END
GO

EXECUTE THEM_NHANVIEN 15, N'AMEN TRAN', 1, 2, '01/01/2003',0,'01/01/2022',NULL
EXECUTE THEM_NHANVIEN 17, N'VU NGUYEN ', 1, 1, '01/03/1967',0,'05/05/2023',NULL
GO



--------------------------------------------------------------------------------
CREATE PROCEDURE THEM_SANPHAM
    @MASP CHAR(5),
    @MALOAI CHAR(5),
    @TENSP NVARCHAR(100),
    @DONGIA DECIMAL
    AS
    BEGIN
    IF EXISTS (SELECT * FROM LOAISANPHAM WHERE LOAISANPHAM.MALOAI = @MALOAI)
        INSERT INTO SANPHAM VALUES (@MASP, @MALOAI,@TENSP,@DONGIA)
    ELSE
        PRINT N'KHONG CO LOAI SAN PHAM, KIEM TRA LAI'
END

EXECUTE THEM_SANPHAM '21','1','CAFFEE CON CHON',500000
GO



-------------------------------------2---------------------------------------------------------
CREATE PROCEDURE THEM_LOAISANPHAM
    @MALOAI CHAR(5),
    @TENLOAI NVARCHAR(100)
    AS
    BEGIN
    INSERT INTO LOAISANPHAM VALUES (@MALOAI, @TENLOAI)
END
GO



EXECUTE THEM_LOAISANPHAM N22 , N'TOMATO'
GO


-------------------------------------------------------------------------------------------

CREATE PROCEDURE SUA_SANPHAM
    @MASP CHAR(5),
    @MALOAI CHAR(5),
    @TENSP NVARCHAR(100),
    @DONGIA DECIMAL
    AS
    BEGIN
    IF EXISTS (SELECT * FROM SANPHAM WHERE SANPHAM.MASP = @MASP)
        IF EXISTS (SELECT * FROM LOAISANPHAM WHERE LOAISANPHAM.MALOAI = @MALOAI)
        UPDATE SANPHAM SET 
        MALOAI = @MALOAI, TENSANPHAM = @TENSP, DONGIA = @DONGIA FROM SANPHAM
        WHERE MASP = @MASP
        ELSE
        PRINT N'LOI MA LOAI'
    ELSE
    PRINT N'LOI SAN PHAM'
    END

    EXECUTE SUA_SANPHAM 1, 1, N'SUA CHUA', 50000
    GO 


----------------------------------------------------------------
 CREATE PROCEDURE LIETKE_SANPHAM
    @MALOAI CHAR(5)
    AS
    BEGIN
    IF EXISTS (SELECT * FROM SANPHAM WHERE MALOAI LIKE @MALOAI)
        SELECT SANPHAM.TENSANPHAM, SANPHAM.DONGIA FROM SANPHAM, LOAISANPHAM
        WHERE SANPHAM.MALOAI = LOAISANPHAM.MALOAI AND LOAISANPHAM.MALOAI = @MALOAI
    ELSE
        PRINT N'LOI KHONG TON TAI LOAI SAN PHAM NAY'
    END

    EXECUTE LIETKE_SANPHAM 1
    GO

--------------------------------------3---------------------------------------------
 CREATE PROCEDURE THONGKE_TONGTHU
    @THANGNAM1 DATETIME,
    @THANGNAM2 DATETIME,
    @@TONGTHU FLOAT OUTPUT
    AS
    BEGIN 
    IF(@THANGNAM1 <= @THANGNAM2)
        BEGIN 
        SELECT SUM(HOADON.TONGTIEN) + (SELECT SUM(PHIEUPHUTHU.SOTIEN) FROM PHIEUPHUTHU WHERE PHIEUPHUTHU.NGAYLAP >=@THANGNAM1 AND PHIEUPHUTHU.NGAYLAP <= @THANGNAM2 )
        AS N'TONG TIEN ' FROM HOADON WHERE
        HOADON.NGAYLAP >= @THANGNAM1 AND HOADON.NGAYLAP <= @THANGNAM2
        
        SELECT @@TONGTHU = SUM(HOADON.TONGTIEN) + (SELECT SUM(PHIEUPHUTHU.SOTIEN) FROM PHIEUPHUTHU WHERE PHIEUPHUTHU.NGAYLAP >= @THANGNAM1 AND PHIEUPHUTHU.NGAYLAP <= @THANGNAM2)
        FROM HOADON WHERE HOADON.NGAYLAP >= @THANGNAM1 AND HOADON.NGAYLAP <= @THANGNAM2
        END
        ELSE 
        PRINT N' LOI TIME'
        END
GO


DECLARE @@TONGTHUHETHONG FLOAT
EXECUTE THONGKE_TONGTHU '20230101', '20230105' ,@@TONGTHUHETHONG OUTPUT
IF(@@TONGTHUHETHONG >100000)
    PRINT N'TONG THU HE THONG LA: ' + CAST(@@TONGTHUHETHONG AS NVARCHAR(100))
    ELSE
        PRINT N'TONG THU IT QUA'
GO


    --------------------------------------------------------------------------------------------------

CREATE PROCEDURE THONGKE_TONGCHI
    @THANGNAM1 DATETIME,
    @THANGNAM2 DATETIME,
    @@TONGCHI FLOAT OUTPUT
    AS
    BEGIN
    IF(@THANGNAM1 <= @THANGNAM2)
    BEGIN 
        SELECT SUM(PHIEUNHAP.TONGTIEN)+ 
        (SELECT SUM(PHIEUCHI.TONGTIEN) FROM PHIEUCHI 
        WHERE PHIEUCHI.NGAYLAP >= @THANGNAM1 AND PHIEUCHI.NGAYLAP <= @THANGNAM2 )
        AS N'TONG CHI HE THONG ' FROM PHIEUNHAP 
        WHERE PHIEUNHAP.NGAYLAP >= @THANGNAM1 AND PHIEUNHAP.NGAYLAP <= @THANGNAM2

    SELECT @@TONGCHI = SUM(PHIEUNHAP.TONGTIEN) + 
    (SELECT SUM(PHIEUCHI.TONGTIEN) FROM PHIEUCHI
    WHERE PHIEUCHI.NGAYLAP >= @THANGNAM1 AND PHIEUCHI.NGAYLAP <=@THANGNAM2)
    FROM PHIEUNHAP WHERE PHIEUNHAP.NGAYLAP >= @THANGNAM1 AND PHIEUNHAP.NGAYLAP <= @THANGNAM2
    END
    ELSE
    PRINT N' LOI TIME'
    END
GO



DECLARE @@TONGCHIHETHONG FLOAT
EXECUTE THONGKE_TONGCHI '20230101', '20230105' ,@@TONGCHIHETHONG OUTPUT
IF(@@TONGCHIHETHONG >100000)
PRINT N'TONG CHI HE THONG LA : ' + CAST(@@TONGCHIHETHONG AS NVARCHAR(100))
ELSE
PRINT N'TONG CHI IT QUA'
GO


-----------------------------------------------------------------------------------


CREATE PROCEDURE THONGKE_LOINHUAN 
@THANGNAM1 DATETIME,
@THANGNAM2 DATETIME,
@@LOINHUAN FLOAT OUTPUT
AS
BEGIN
IF(@THANGNAM1 <= @THANGNAM2)
BEGIN   
    SELECT SUM(HOADON.TONGTIEN) + 
    (SELECT SUM(PHIEUPHUTHU.SOTIEN) FROM PHIEUPHUTHU 
    WHERE PHIEUPHUTHU.NGAYLAP >= @THANGNAM1 AND PHIEUPHUTHU.NGAYLAP <= @THANGNAM2) - 
    (SELECT SUM(PHIEUNHAP.TONGTIEN)+
    (SELECT SUM(PHIEUCHI.TONGTIEN) FROM PHIEUCHI
    WHERE PHIEUCHI.NGAYLAP >= @THANGNAM1 AND PHIEUCHI.NGAYLAP <= @THANGNAM2)
    FROM PHIEUNHAP 
    WHERE PHIEUNHAP.NGAYLAP >= @THANGNAM1 AND PHIEUNHAP.NGAYLAP <= @THANGNAM2)
    FROM HOADON WHERE HOADON.NGAYLAP >= @THANGNAM1 AND HOADON.NGAYLAP <= @THANGNAM2

    SELECT @@LOINHUAN = SUM(HOADON.TONGTIEN) + 
    (SELECT SUM(PHIEUPHUTHU.SOTIEN) FROM PHIEUPHUTHU 
    WHERE PHIEUPHUTHU.NGAYLAP >= @THANGNAM1 AND PHIEUPHUTHU.NGAYLAP <= @THANGNAM2) - 
    (SELECT SUM(PHIEUNHAP.TONGTIEN)+
    (SELECT SUM(PHIEUCHI.TONGTIEN) FROM PHIEUCHI
    WHERE PHIEUCHI.NGAYLAP >= @THANGNAM1 AND PHIEUCHI.NGAYLAP <= @THANGNAM2)
    FROM PHIEUNHAP 
    WHERE PHIEUNHAP.NGAYLAP >= @THANGNAM1 AND PHIEUNHAP.NGAYLAP <= @THANGNAM2)
    FROM HOADON WHERE HOADON.NGAYLAP >= @THANGNAM1 AND HOADON.NGAYLAP <= @THANGNAM2
    END
    ELSE
    PRINT N'LOI TIME'
    END
    GO



    DECLARE @@LOINHUANHETHONG FLOAT
    EXECUTE THONGKE_LOINHUAN '20230101' , '20230105', @@LOINHUANHETHONG OUTPUT
    IF(@@LOINHUANHETHONG > 100000)
        PRINT N'TONG LOI NGUAN LA : ' + CAST(@@LOINHUANHETHONG AS NVARCHAR(100))
    ELSE
        PRINT N'LOI NHUAN IT'

    GO


----------------------------------------------------------------------------------


CREATE PROCEDURE TIENMOINGAY
    @NGAY DATETIME,
    @TONGTIEN FLOAT OUTPUT
    AS
    BEGIN
    SELECT SUM(HOADON.TONGTIEN) AS N' TỔNG TIỀN' FROM HOADON WHERE NGAYLAP = @NGAY;
    SELECT @TONGTIEN = SUM(HOADON.TONGTIEN) FROM HOADON WHERE NGAYLAP = @NGAY;
    END



DECLARE @TIEN FLOAT
EXECUTE TIENMOINGAY '20230102', @TIEN OUTPUT
        -- SU DUNG BIEN OUTPUT @TIEN
IF(@TIEN > 1000)
    PRINT N'TONG TIEN LA: '+ CAST(@TIEN AS NVARCHAR(100))
ELSE PRINT N' KHONG CO TIEN'
GO






-----------------------------------FUNCION------------------------------------------------------------

------------------------LOAI 1-----------------------------------------------

--------------------TÍNH TỔNG SỐ ƯỢNG SẢN PHẨM CỦA HÓA ĐƠN------------------------------------

CREATE FUNCTION dbo.TinhTong_SP (@MAHD CHAR(50))
RETURNS INT
AS
BEGIN
    DECLARE @TONGSL INT;
    
    SELECT @TONGSL = SUM(SOLUONG)
    FROM CHITIET_HOADON
    WHERE MAHD = @MAHD;
    
    RETURN @TONGSL;
END
GO

SELECT dbo.TinhTong_SP(1)
GO

----------------------------------------


-------------TINH TONG GIA TRI CUA HOA DON
CREATE FUNCTION dbo.TongGT_HoaDon (@MAHD CHAR(50))
RETURNS DECIMAL(18, 2)
AS
BEGIN
    DECLARE @TongGT DECIMAL(18, 2);
    
    SELECT @TongGT = SUM(SP.DONGIA * CTHD.SOLUONG)
    FROM CHITIET_HOADON CTHD 
    INNER JOIN SANPHAM SP ON CTHD.MASP = SP.MASP
    WHERE MAHD = @MAHD;
    
    RETURN @TongGT;
END
GO

SELECT dbo.TinhTong_SP(5)
GO



----------------------------------------------

----------------LẤY TÊN CV NHÂN VIÊN--------------------
CREATE FUNCTION dbo.Lay_TenCV (@MANV CHAR(5))
RETURNS NVARCHAR(50)
AS
BEGIN
    DECLARE @CV NVARCHAR(50);
    
    SELECT @CV = TENCV
    FROM CHUCVU CV
    INNER JOIN NHANVIEN NV ON CV.MACV = NV.MACV
    WHERE MANV = @MANV;
    
    RETURN @CV;
END
GO


SELECT dbo.Lay_TenCV(1)
GO




----------------------------LOAI--2-----------------------------------------------

-------------------------------- XUAT RA TEN SP THEO MA LOAI-------------------------------
CREATE FUNCTION DBO.PHANTHEOLOAI(@MALOAI CHAR(5))
RETURNS TABLE
AS
RETURN SELECT TENSANPHAM,DONGIA  
FROM SANPHAM
WHERE MALOAI = @MALOAI 
GO

SELECT * FROM DBO.PHANTHEOLOAI(5)
GO


-- DROP FUNCTION DBO.PHANTHEOLOAI
-- GO




------------------------------------XUAT RA DIA CHI CUA NHA CUNG CAP------------------------


CREATE FUNCTION dbo.DIACHI_THONGTIN_NCC()
RETURNS TABLE
AS
RETURN
(
    SELECT NC.MANCC, DN.DIACHI
    FROM NHACUNGCAP NC
    INNER JOIN DIACHI_NCC DN ON NC.MANCC = DN.MANCC
)
GO

SELECT * FROM dbo.DIACHI_THONGTIN_NCC()
GO


-----------------------------XUAT RA DIA CHI CUA NHAN VIEN ----------------------------------


CREATE FUNCTION dbo.DIACHI_THONGTIN_NHANVIEN()
RETURNS TABLE
AS
RETURN
(
    SELECT NV.MANV, DN.DIACHI
    FROM NHANVIEN NV
    INNER JOIN DIACHI_NHANVIEN DN ON NV.MANV = DN.MANV
)
GO


SELECT * FROM dbo.DIACHI_THONGTIN_NHANVIEN()
GO
------------------------------------------------------------------------------------





---------------------------------LOAI--3-----------------------------------------------

---------LẤY DS SẢN PHẨM 1 HÓA ĐƠN CỤ THỂ---------------------------------
CREATE FUNCTION dbo.SP_IN_HOADON (@MAHD CHAR(50))
RETURNS @SANPHAM TABLE (
    MASP CHAR(5),
    TENSANPHAM NVARCHAR(100),
    DONGIA DECIMAL,
    SOLUONG FLOAT
)
AS
BEGIN
    INSERT INTO @SANPHAM (MASP, TENSANPHAM, DONGIA, SOLUONG)
    SELECT SP.MASP, SP.TENSANPHAM, SP.DONGIA, CTHD.SOLUONG
    FROM SANPHAM SP
    INNER JOIN CHITIET_HOADON CTHD ON SP.MASP = CTHD.MASP
    INNER JOIN HOADON HD ON CTHD.MAHD = HD.MAHD
    WHERE HD.MAHD = @MAHD;
    
    RETURN;
END
GO

SELECT * FROM dbo.SP_IN_HOADON(1)
GO




------------------------------------TRIGGER--------------------------------------------------

-------------------------------1-------------------------------------------------------------


CREATE TRIGGER BAY_TUOI ON NHANVIEN 
INSTEAD OF INSERT
AS
BEGIN 
    DECLARE @MANV CHAR(5);
    DECLARE @TENNV NVARCHAR(100);
    DECLARE @MACV CHAR(3);
    DECLARE @MACN CHAR(5);
    DECLARE @NGAYSINH DATETIME;
    DECLARE @GT BIT;
    DECLARE @NGAYVAO DATETIME;
    DECLARE @NGAYNGHI DATETIME;

    SELECT @MANV = MANV FROM inserted;
    SELECT @TENNV = TENNV FROM inserted;
    SELECT @MACV = MACV FROM inserted;
    SELECT @MACN = MACN FROM inserted;
    SELECT @NGAYSINH = NGAYSINH FROM inserted;
    SELECT @GT = GIOITINH FROM inserted;
    SELECT @NGAYVAO = NGAYVAO FROM inserted;
    SELECT @NGAYNGHI = NGAYNGHI FROM inserted;

        IF EXISTS (SELECT * FROM NHANVIEN WHERE MANV=@MANV)
        BEGIN
            PRINT N'LOI: DA TON TAI NHAN VIEN NAY'
        ROLLBACK TRAN 
    END 
    ELSE 
    IF EXISTS (SELECT * FROM inserted WHERE (YEAR(GETDATE())-YEAR(inserted.NGAYSINH))<=18)

    BEGIN
        PRINT N'LOI: CHUA DU 18T'
        ROLLBACK TRAN
    END
    ELSE
    INSERT INTO NHANVIEN VALUES (@MANV,@TENNV,@MACV,@MACN,@NGAYSINH,@GT,@NGAYVAO,@NGAYNGHI);
END
GO



INSERT INTO NHANVIEN VALUES (33,N'HA ANH TUAN',1,1,'20070101',0,'20230101',NULL)
GO




--------------------------------------------------------------------------------------

CREATE TRIGGER TREN_18_TUOI ON NHANVIEN
FOR UPDATE
AS
BEGIN
    DECLARE @MANV CHAR(5);
    DECLARE @TENNV NVARCHAR(100);
    DECLARE @MACV CHAR(3);
    DECLARE @MACN CHAR(5);
    DECLARE @NGAYSINH DATETIME;
    DECLARE @GT BIT;
    DECLARE @NGAYVAO DATETIME;
    DECLARE @NGAYNGHI DATETIME;

    SELECT @MANV = MANV FROM inserted;
    SELECT @TENNV = TENNV FROM inserted;
    SELECT @MACV = MACV FROM inserted;
    SELECT @MACN = MACN FROM inserted;
    SELECT @NGAYSINH = NGAYSINH FROM inserted;
    SELECT @GT = GIOITINH FROM inserted;
    SELECT @NGAYVAO = NGAYVAO FROM inserted;
    SELECT @NGAYNGHI = NGAYNGHI FROM inserted;

    IF EXISTS (SELECT * FROM inserted WHERE (YEAR(GETDATE())-YEAR(inserted.NGAYSINH))<=18)
        BEGIN   
            PRINT N'LOI : CHUA DU 18 TUOI'
            ROLLBACK TRAN
        END
END
GO


UPDATE [dbo].[NHANVIEN]
SET
    [NGAYSINH] = '20190101'
WHERE MANV = 1
GO

-----------------------------------------------------------------------------------------

CREATE TRIGGER XOANHANVIEN ON NHANVIEN 
INSTEAD OF DELETE
AS
BEGIN
    DECLARE @D CHAR(5);
    DECLARE @HD CHAR(50);
    DECLARE @PN CHAR(10);
    DECLARE @NGAYVAO DATETIME;
    DECLARE @NGAYNGHI DATETIME;

    SELECT @D = MANV FROM deleted;
    SELECT @NGAYNGHI = NGAYNGHI FROM deleted;
    SELECT @NGAYNGHI = NGAYNGHI FROM deleted;
    IF(@NGAYNGHI != NULL)
        IF(@NGAYNGHI-@NGAYVAO> 12)
        BEGIN
            --XOA DIA CHI
            DELETE FROM DIACHI_NHANVIEN WHERE MANV = @D;
            --XOA SDT
            DELETE FROM SDT_NHANVIEN WHERE MANV = @D;
            --XOA EMAIL
            DELETE FROM EMAIL_NHANVIEN WHERE MANV=@D
            --XOA CHI TIET PHIEU NHAP
            SELECT @PN = B.MAPN FROM CHITIET_PHIEUNHAP A JOIN PHIEUNHAP B ON A.MAPN = B.MAPN WHERE B. MANV =@D;
            DELETE FROM CHITIET_PHIEUNHAP WHERE MAPN = @PN;
            --XOA PHIEU NHAP
            DELETE FROM PHIEUNHAP WHERE MAPN = @PN;
            --XOA PHIEU CHI
            DELETE FROM PHIEUCHI WHERE MANV = @D;
            --XOA PHIEU PHU THU 
            DELETE FROM PHIEUPHUTHU WHERE MANV = @D;
            --XOA CHI TIET HOA DON 
            SELECT @HD = B.MAHD FROM CHITIET_HOADON A JOIN HOADON B ON A.MAHD=B.MAHD WHERE B.MAHD = @D;
            DELETE FROM CHITIET_HOADON WHERE MAHD = @D;
            --XOA HOA DON 
            DELETE FROM HOADON WHERE MAHD =@HD;
            DELETE FROM NHANVIEN WHERE MANV = @D;
        END
        ELSE
            BEGIN
            PRINT N' LOI, NHAN VIEN CHUA NGHI HOWN 12 THANG'
        END
    ELSE
        BEGIN
        PRINT N'LOI, NHAN VIEN NAY CHUA NGHI'
    END
END
GO


SELECT * FROM NHANVIEN WHERE MANV=1
DELETE FROM NHANVIEN WHERE MANV=1
GO


----------------------------------------------------------------------------------------

CREATE TRIGGER KT_EMAIL_NCC ON EMAIL_NCC
FOR INSERT, UPDATE
AS
IF EXISTS (SELECT * FROM inserted WHERE EMAIL NOT LIKE '%_@__%.'+'com' AND EMAIL NOT LIKE '%_@__%.' + 'vn')
BEGIN
RAISERROR('NHAP KHONG DUNG DINH DANG EMAIL',16,1);
ROLLBACK
END
GO


INSERT INTO EMAIL_NCC VALUES (1,32,N'FFGAK@gmail.humg')
go



--------------------------------------------------------------------------------------------

CREATE TRIGGER KT_EMAIL_NV ON EMAIL_NHANVIEN
FOR INSERT , UPDATE
AS 
IF EXISTS(SELECT * FROM inserted WHERE EMAIL NOT LIKE '%_@__%.' + 'com' AND EMAIL NOT LIKE '%_@__%.' + 'vn' )
BEGIN
RAISERROR('NHAP KHONG DUNG DINH DANG EMAIL ',16,1);
ROLLBACK
END
GO


INSERT INTO EMAIL_NHANVIEN VALUES (1,31,N'MJXBVSBMZXC@GMAIL.com')
INSERT INTO EMAIL_NHANVIEN VALUES (3,33,N'MJXBVSBMZXC@GMAIL.cMD')
GO



---------------------------------------2--------------------------------------------------

CREATE TRIGGER SL_KHONGAM_PHIEUCHI ON PHIEUCHI
    FOR INSERT, UPDATE
    AS
        DECLARE @SL FLOAT
        SELECT @SL= INSERTED.TONGTIEN FROM inserted
        IF(@SL <= 0)
            BEGIN   
                PRINT N'LOI! KHONG DUOC NHAP SO TIEN AM'
                ROLLBACK TRAN
            RETURN
        END
GO


INSERT INTO PHIEUCHI VALUES (21, 1, N'TIEN DIEN', '20230105', 15000600)
INSERT INTO PHIEUCHI VALUES (22,1,N'TIEN NUOC','20230109',-4456346)
GO


---------------------------------------3--------------------------------------------------


CREATE TRIGGER KIEMTRA_TRUNGMA ON BAOCAO
    INSTEAD OF INSERT  
    AS
    DECLARE @MABC CHAR(10);
    DECLARE @MANV CHAR(5);

    DECLARE @TRUNGMA INT;

    SELECT @MABC=MABC FROM inserted;
    SELECT @MANV=MANV FROM inserted;
    SELECT @TRUNGMA= COUNT(*) FROM BAOCAO WHERE MANV=@MANV AND MABC=@MABC;
    IF(@TRUNGMA>0)
    BEGIN   
        PRINT N'CANH BAO : TRUNG MA'
        ROLLBACK TRAN 
        RETURN
    END
    ELSE
    BEGIN
        DECLARE @TEN NVARCHAR(100);
        DECLARE @NGAY DATETIME;
        DECLARE @NOIDUNG NVARCHAR(MAX);

        SELECT @TEN = TENBC FROM inserted;
        SELECT @NGAY = NGAYLAP FROM inserted;
        SELECT @NOIDUNG = NOIDUNG FROM inserted;

        INSERT INTO BAOCAO VALUES(@MABC,@MANV,@TEN,@NGAY,@NOIDUNG)
    END
GO



INSERT INTO BAOCAO VALUES(1,1,N'A','20230516',N'NHAP BAO CAO NGAY 16/5/2023')
GO
-----------------------------------------------------------------------------------------


CREATE TRIGGER KIEMTRA_TRUNGCN ON CHINHANH
    INSTEAD OF INSERT  
    AS
    DECLARE @MACN CHAR(5);
    DECLARE @D INT;
    DECLARE @TRUNGMA INT;

    SELECT @MACN=MACN FROM inserted;
    SELECT @TRUNGMA= COUNT(*) FROM CHINHANH WHERE MACN = @MACN;
    IF(@TRUNGMA>0)
    BEGIN   
        PRINT N'CANH BAO : TRUNG MA'
        ROLLBACK TRAN 
        RETURN
    END
    ELSE
    BEGIN
        DECLARE @TEN NVARCHAR(100);
        DECLARE @HESOGIA FLOAT;
        DECLARE @NOIDUNG NVARCHAR(MAX);

        SELECT @TEN = TENCN FROM inserted;

        INSERT INTO CHINHANH VALUES(@MACN,@TEN)
    END
GO

INSERT INTO CHINHANH VALUES (1,N'HEROIN')
GO


--------------------------------------------------------------------------------------------


CREATE TRIGGER KIEMTRA_CHUCVU ON CHUCVU
    INSTEAD OF INSERT  
    AS
    DECLARE @MACV CHAR(3);
    DECLARE @D INT;
    DECLARE @TRUNGMA INT;

    SELECT @MACV=MACV FROM inserted;
    SELECT @TRUNGMA= COUNT(*) FROM CHUCVU WHERE MACV=@MACV;
    IF(@TRUNGMA>0)
    BEGIN   
        PRINT N'CANH BAO : TRUNG MA'
        ROLLBACK TRAN 
        RETURN
    END
    ELSE
    BEGIN
        DECLARE @TEN NVARCHAR(100);

        SELECT @TEN = TENCV FROM inserted;

        INSERT INTO CHUCVU VALUES(@MACV,@TEN)
    END
GO

INSERT INTO CHUCVU VALUES (1,N'CHU TICH')
GO

---------------------------------------------------------------------------------------------

CREATE TRIGGER KIEMTRA_DIACHINCC ON DIACHI_NCC
   INSTEAD OF INSERT  
    AS
    DECLARE @MANCC CHAR(5);
    DECLARE @MATP CHAR(5);
    DECLARE @MAQ CHAR(5);
    DECLARE @D INT;
    DECLARE @TRUNGMA INT;

    SELECT @MANCC=MANCC FROM inserted;
    SELECT @MATP = MATP FROM inserted;
    SELECT @MAQ = MAQ FROM inserted;
    SELECT @TRUNGMA= COUNT(*) FROM DIACHI_NCC WHERE MANCC=@MANCC;
    IF(@TRUNGMA>0)
    BEGIN   
        PRINT N'CANH BAO : TRUNG MA'
        ROLLBACK TRAN 
        RETURN
    END
    ELSE
    BEGIN
        DECLARE @DIACHI NVARCHAR(100);
        SELECT @DIACHI = DIACHI FROM inserted;
        INSERT INTO DIACHI_NCC VALUES(@MANCC,@MATP,@MAQ,@DIACHI)
    END
GO


INSERT INTO DIACHI_NCC VALUES (1,1,1,N'CAMPUCHIA')
GO

-----------------------------------------------------------------------------------------
CREATE TRIGGER KIEMTRA_DIACHINV ON DIACHI_NHANVIEN
   INSTEAD OF INSERT  
    AS
    DECLARE @MANV CHAR(5);
    DECLARE @MATP CHAR(5);
    DECLARE @MAQ CHAR(5);
    DECLARE @D INT;
    DECLARE @TRUNGMA INT;

    SELECT @MANV=MANV FROM inserted;
    SELECT @MATP = MATP FROM inserted;
    SELECT @MAQ = MAQ FROM inserted;
    SELECT @TRUNGMA= COUNT(*) FROM DIACHI_NHANVIEN WHERE MANV=@MANV;
    IF(@TRUNGMA>0)
    BEGIN   
        PRINT N'CANH BAO : TRUNG MA'
        ROLLBACK TRAN 
        RETURN
    END
    ELSE
    BEGIN
        DECLARE @DIACHI NVARCHAR(100);

        SELECT @DIACHI = DIACHI FROM inserted;

        INSERT INTO DIACHI_NHANVIEN VALUES(@MANV,@MATP,@MAQ,@DIACHI)
    END
GO


INSERT INTO DIACHI_NHANVIEN VALUES (1,1,1,N'NAM DINH')
GO

--------------------------------------------------------------------------------------------
CREATE TRIGGER KIEMTRA_QUANHUYEN ON QUAN_HUYEN
   INSTEAD OF INSERT  
    AS
    DECLARE @MAQ CHAR(5);
    DECLARE @D INT;
    DECLARE @TRUNGMA INT;

    SELECT @MAQ=MAQ FROM inserted;
    SELECT @TRUNGMA= COUNT(*) FROM QUAN_HUYEN WHERE MAQ=@MAQ;
    IF(@TRUNGMA>0)
    BEGIN   
        PRINT N'CANH BAO : TRUNG MA'
        ROLLBACK TRAN 
        RETURN
    END
    ELSE
    BEGIN
        DECLARE @TEN NVARCHAR(100);

        SELECT @TEN = TENQ FROM inserted;

        INSERT INTO CHUCVU VALUES(@MAQ,@TEN)
    END
GO

INSERT INTO QUAN_HUYEN VALUES (1, N'NAM TU LIEM')
GO


-------------------------------------------------------------------------------------------
CREATE TRIGGER KIEMTRA_TINHTP ON TINH_THANHPHO
   INSTEAD OF INSERT  
    AS
    DECLARE @MATP CHAR(5);
    DECLARE @D INT;
    DECLARE @TRUNGMA INT;

    SELECT @MATP=MATP FROM inserted;
    SELECT @TRUNGMA= COUNT(*) FROM TINH_THANHPHO WHERE MATP=@MATP;
    IF(@TRUNGMA>0)
    BEGIN   
        PRINT N'CANH BAO : TRUNG MA'
        ROLLBACK TRAN 
        RETURN
    END
    ELSE
    BEGIN
        DECLARE @TEN NVARCHAR(100);

        SELECT @TEN = TENTP FROM inserted;

        INSERT INTO CHUCVU VALUES(@MATP,@TEN)
    END
GO

INSERT INTO TINH_THANHPHO VALUES (1, N'LAO CAI')
GO



----------------------------------------------------------------------


